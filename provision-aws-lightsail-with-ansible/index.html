<!doctype html><html><head>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1">
<meta name=description content="栖雲樓">
<link rel="shortcut icon" href=https://hujiale.me/favicon.ico>
<link rel=stylesheet href=/css/style.min.css>
<title>Provision AWS Lightsail with Ansible</title>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-Q50DZDP25S"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date),gtag('config','G-Q50DZDP25S',{anonymize_ip:!1})}</script>
</head>
<body><header id=banner>
<h2><a href=https://hujiale.me>栖雲樓</a></h2>
<nav>
<ul>
<li>
<a href=/ title=posts>posts</a>
</li><li>
<a href=/me/ title=me>me</a>
</li>
</ul>
</nav>
</header>
<main id=content>
<article>
<header id=post-header>
<h1>Provision AWS Lightsail with Ansible</h1>
<div>
Updated <time>January 10, 2022</time>
</div>
</header><p>Amazon has announced a new cloud service <strong>Lightsail</strong> recently aiming at DigitalOcean, with exact same price and same spec of node. As a heavy DigitalOcean user, I am more than happy to try the alternative provided by AWS. Creating the first instance is not smooth, I got successfully created the first instance by AWS SDK after 3 weeks in and out mails with the support team.</p>
<p>TL;DR</p>
<p>This post is a quick guide on provisioning the instance by Ansible. Before that , some outlines:</p>
<ul>
<li>The default login account for Lightsail is pretty much depended on the image, while in DigitalOcean it is <strong>root</strong>.</li>
<li>Lightsail is using key pair (.pem) for ssh login, you can either use default key pair or create a new pair. After successfully log into the instance, I added a pub ssh id by my preference.</li>
<li>Everything in docker, as well as ansible</li>
</ul>
<h2 id=ansible-playbook>Ansible playbook</h2>
<p>provision.yml</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-yml data-lang=yml><span class=nn>---</span><span class=w>
</span><span class=w></span>- <span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class=l>cloud </span><span class=w>
</span><span class=w>  </span><span class=nt>gather_facts</span><span class=p>:</span><span class=w> </span><span class=kc>False</span><span class=w>
</span><span class=w>  </span><span class=nt>tasks</span><span class=p>:</span><span class=w>
</span><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Update local known_hosts</span><span class=w>
</span><span class=w>      </span><span class=nt>local_action</span><span class=p>:</span><span class=w> </span><span class=l>shell ssh-keyscan -H {{ hostvars[item].ansible_host }} &gt;&gt; ~/.ssh/known_hosts</span><span class=w>
</span><span class=w>      </span><span class=nt>with_items</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;{{ groups.cloud }}&#34;</span><span class=w>
</span><span class=w>
</span><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Install aptitude</span><span class=w>
</span><span class=w>      </span><span class=nt>raw</span><span class=p>:</span><span class=w> </span><span class=l>test ! -e /usr/bin/aptitude &amp;&amp; sudo apt-get install -qq aptitude || true</span><span class=w>
</span><span class=w>
</span><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Install python 2.7</span><span class=w>
</span><span class=w>      </span><span class=nt>raw</span><span class=p>:</span><span class=w> </span><span class=l>test ! -e /usr/bin/python &amp;&amp; (sudo apt-get update -qq &amp;&amp; sudo apt-get install -qq python2.7) || true</span><span class=w>
</span><span class=w>
</span><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Install letsencrypt </span><span class=w>
</span><span class=w>      </span><span class=nt>raw</span><span class=p>:</span><span class=w> </span><span class=l>test ! -e /usr/bin/letsencrypt &amp;&amp; (sudo apt-get update -qq &amp;&amp; sudo apt-get install -qq letsencrypt) || true</span><span class=w>
</span><span class=w>
</span><span class=w></span>- <span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class=l>cloud </span><span class=w>
</span><span class=w>  </span><span class=nt>roles</span><span class=p>:</span><span class=w>
</span><span class=w>    </span>- <span class=l>update-apt</span><span class=w>
</span><span class=w>    </span>- <span class=l>user</span><span class=w>
</span><span class=w>    </span>- <span class=l>swap</span><span class=w>
</span><span class=w>
</span><span class=w></span>- <span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class=l>cloud </span><span class=w>
</span><span class=w>  </span><span class=nt>roles</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=c># https://github.com/angstwad/docker.ubuntu</span><span class=w>
</span><span class=w>    </span>- <span class=nt>role</span><span class=p>:</span><span class=w> </span><span class=l>angstwad.docker_ubuntu</span><span class=w>
</span><span class=w>      </span><span class=nt>become</span><span class=p>:</span><span class=w> </span><span class=kc>yes</span><span class=w>
</span><span class=w>      </span><span class=nt>kernel_pkg_state</span><span class=p>:</span><span class=w> </span><span class=l>present</span><span class=w>
</span></code></pre></div><p>provision.ini</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-ini data-lang=ini><span class=k>[hosts]</span>
<span class=k>[YOUR_LIGHTSAIL_INSTANCE_NAME] ansible_host=[YOUR_IP] private_ip=[YOUR_PRIVATE_IP]</span>

<span class=k>[cloud:children]</span>
<span class=na>hosts</span>

<span class=k>[cloud:vars]</span>
<span class=na>ansible_connection</span><span class=o>=</span><span class=s>ssh</span>
<span class=na>ansible_user</span><span class=o>=</span><span class=s>ubuntu</span>
<span class=na>ansible_ssh_private_key_file</span><span class=o>=</span><span class=s>~/.ssh/id_rsa</span>
<span class=na>ansible_python_interpreter</span><span class=o>=</span><span class=s>/usr/bin/python2.7</span>
</code></pre></div><p>Looking at <code>provision.yml</code> , the first 3 common tasks are pretty straight forward:</p>
<ul>
<li>Adding remote instance IP to your local known_hosts</li>
<li>Install Python</li>
<li>Install letsencrypt for HTTPS</li>
</ul>
<p>Followed by 3 common roles:</p>
<ul>
<li>Update and upgrade apt</li>
<li>Create application user in sudo group</li>
<li>Specify swap file (optional)</li>
</ul>
<p>I would like to pick user role as example</p>
<p>ansible/roles/user/tasks/main.yml</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-yml data-lang=yml><span class=nn>---</span><span class=w>
</span><span class=w></span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Ensure user exists</span><span class=w>
</span><span class=w>  </span><span class=nt>become</span><span class=p>:</span><span class=w> </span><span class=kc>yes</span><span class=w>
</span><span class=w>  </span><span class=nt>user</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>appuser</span><span class=w>
</span><span class=w>    </span><span class=nt>state</span><span class=p>:</span><span class=w> </span><span class=l>present</span><span class=w>
</span><span class=w>    </span><span class=nt>shell</span><span class=p>:</span><span class=w> </span><span class=l>/bin/bash</span><span class=w>
</span><span class=w>    </span><span class=nt>append</span><span class=p>:</span><span class=w> </span><span class=kc>yes</span><span class=w> 
</span><span class=w>    </span><span class=nt>groups</span><span class=p>:</span><span class=w> </span><span class=l>sudo</span><span class=w>
</span><span class=w>
</span><span class=w></span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Ensure authorized key exists</span><span class=w>
</span><span class=w>  </span><span class=nt>become</span><span class=p>:</span><span class=w> </span><span class=kc>yes</span><span class=w>
</span><span class=w>  </span><span class=nt>authorized_key</span><span class=p>:</span><span class=w> </span><span class=l>user=appuser key=&#34;{{ lookup(&#39;file&#39;, &#39;~/.ssh/id_rsa.pub&#39;) }}&#34;</span><span class=w>
</span><span class=w>
</span><span class=w></span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Copy sudoers</span><span class=w>
</span><span class=w>  </span><span class=nt>become</span><span class=p>:</span><span class=w> </span><span class=kc>yes</span><span class=w>
</span><span class=w>  </span><span class=nt>copy</span><span class=p>:</span><span class=w> </span><span class=l>src=./sudoers dest=/etc/sudoers</span><span class=w>
</span></code></pre></div><p>This role will create a user <code>appuser</code> in sudo group for application deploy. So that we don’t need to use the default user <code>ubuntu</code> every time. Make sure you have added the id pub key into the instance’s <code>authorized_key</code> file</p>
<p>The last role is installing docker into the instance, after that you can use any docker command like <code>sudo docker</code> or <code>sudo docker-compose</code> in the instance and it’s armed with docker engine now.</p>
<p>OK now we have a provisioned instance and keep lego it with any application you write. I will suggest to use Ansible docker service as well to depoly your application based on docker image.</p>
</article>
</main><footer id=footer>
Copyright © 2022 hjl
</footer>
</body>
</html>