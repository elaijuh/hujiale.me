<!doctype html><html><head>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1">
<meta name=description content="栖雲樓">
<link rel="shortcut icon" href=https://hujiale.me/favicon.ico>
<link rel=stylesheet href=/css/style.min.css>
<title>Cron need root password to be set</title>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-Q50DZDP25S"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date),gtag('config','G-Q50DZDP25S',{anonymize_ip:!1})}</script>
</head>
<body><header id=banner>
<h2><a href=https://hujiale.me>栖雲樓</a></h2>
<nav>
<ul>
<li>
<a href=/ title=posts>posts</a>
</li><li>
<a href=/me/ title=me>me</a>
</li>
</ul>
</nav>
</header>
<main id=content>
<article>
<header id=post-header>
<h1>Cron need root password to be set</h1>
<div>
Updated <time>January 10, 2022</time>
</div>
</header><p>I am using Digital Ocean with password login disabled. I provision new machine using ansible userdata, so that every team member can login by ssh.
Everything works fine until one day I find cron job doesn&rsquo;t work correctly under root.</p>
<p>The error log is
<code>pam_unix(cron:account): expired password for user root (root enforced)</code></p>
<p>The tricky part is, when creating a new droplet, Digital Ocean needs you to login by initial password and reset it immediately. As I am using terraform to create new droplet and ansible to provision it, I miss the reset password part. But how immediate reset works? The file <code>/etc/shadow</code> is the key to it. It saves the user and password information. It looks like this:</p>
<p><code>root:&lt;hashed_password>:0:0:14600:14:::</code></p>
<p>Each field in the shadow file is also separated with &ldquo;:&rdquo; colon characters, and are as follows:</p>
<p>Username, up to 8 characters. Case-sensitive, usually all lowercase. A direct match to the username in the /etc/passwd file.</p>
<p>Password, 13 character encrypted. A blank entry (eg. ::) indicates a password is not required to log in (usually a bad idea), and a &ldquo;<em>&rdquo; entry (eg. :</em>:) indicates the account has been disabled.</p>
<p>The number of days (since January 1, 1970) since the password was last changed.</p>
<p>The number of days before password may be changed (0 indicates it may be changed at any time)</p>
<p>The number of days after which password must be changed (99999 indicates user can keep his or her password unchanged for many, many years)</p>
<p>The number of days to warn user of an expiring password (7 for a full week)</p>
<p>The number of days after password expires that account is disabled</p>
<p>The number of days since January 1, 1970 that an account has been disabled</p>
<p>A reserved field for possible future use</p>
<p>There is also a easy command <code>chage</code> to check these information with human readable format, <code>sudo chage -l root</code></p>
<p>So to solve the cron problem, instead of update the VPS set initial root password, I can just update number of days since the password was last changed.</p>
<p><code>sudo chage -d 2017-09-30 root</code></p>
<p>Now cron should work as expected.</p>
</article>
</main><footer id=footer>
Copyright © 2022 hjl
</footer>
</body>
</html>