<!doctype html><html><head>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1">
<meta name=description content="栖雲樓">
<link rel="shortcut icon" href=https://hujiale.me/favicon.ico>
<link rel=stylesheet href=/css/style.min.css>
<title>Unit test Angular directive</title>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-Q50DZDP25S"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date),gtag('config','G-Q50DZDP25S',{anonymize_ip:!1})}</script>
</head>
<body><header id=banner>
<h2><a href=https://hujiale.me>栖雲樓</a></h2>
<nav>
<ul>
<li>
<a href=/ title=posts>posts</a>
</li><li>
<a href=/me/ title=me>me</a>
</li>
</ul>
</nav>
</header>
<main id=content>
<article>
<header id=post-header>
<h1>Unit test Angular directive</h1>
<div>
Updated <time>January 10, 2022</time>
</div>
</header><p>I seldom test angular directive unless there is some DOM mutation being processed in the directive, like add/remove classes, show/hide elements or compile/destroy elements. If you have a heavy dependencies on directives, the unit test will be a little bit clunky as for mocking the inline controller of the required directive. Stack overflow gives several alternatives to do so, I am picking two of them which I prefer to go and demo them here. At the bottom of this post, I will attach the SO link for reference.</p>
<p><span class=more></span></p>
<p>Let say we have two directives <code>foo</code> and <code>bar</code> here and bar is requiring foo for it&rsquo;s controller. We want to test directive <code>bar</code>.</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=c1>// index.html
</span><span class=c1>// &lt;foo&gt;&lt;bar&gt;{{bar}}&lt;/bar&gt;&lt;/foo&gt;
</span><span class=c1></span>
<span class=c1>// app.js
</span><span class=c1></span><span class=nx>app</span>
  <span class=p>.</span><span class=nx>directive</span><span class=p>(</span><span class=s1>&#39;foo&#39;</span><span class=p>,</span> <span class=kd>function</span> <span class=p>()</span> <span class=p>{</span>
    <span class=k>return</span> <span class=p>{</span>
      <span class=nx>restrict</span><span class=o>:</span> <span class=s1>&#39;EA&#39;</span><span class=p>,</span>
      <span class=nx>controller</span><span class=o>:</span> <span class=kd>function</span> <span class=p>()</span> <span class=p>{</span>
        <span class=k>this</span><span class=p>.</span><span class=nx>getFoo</span> <span class=o>=</span> <span class=kd>function</span> <span class=p>()</span> <span class=p>{</span>
          <span class=k>return</span> <span class=s1>&#39;foo&#39;</span><span class=p>;</span>
        <span class=p>};</span>
      <span class=p>},</span>
      <span class=nx>link</span><span class=o>:</span> <span class=nx>angular</span><span class=p>.</span><span class=nx>noop</span>
    <span class=p>}</span>
  <span class=p>})</span>
  <span class=p>.</span><span class=nx>directive</span><span class=p>(</span><span class=s1>&#39;bar&#39;</span><span class=p>,</span> <span class=kd>function</span> <span class=p>()</span> <span class=p>{</span>
    <span class=k>return</span> <span class=p>{</span>
      <span class=nx>restrict</span><span class=o>:</span> <span class=s1>&#39;EA&#39;</span><span class=p>,</span>
      <span class=nx>require</span><span class=o>:</span> <span class=s1>&#39;^foo&#39;</span><span class=p>,</span>
      <span class=nx>link</span><span class=o>:</span> <span class=kd>function</span> <span class=p>(</span><span class=nx>scope</span><span class=p>,</span> <span class=nx>elm</span><span class=p>,</span> <span class=nx>attrs</span><span class=p>,</span> <span class=nx>controller</span><span class=p>)</span> <span class=p>{</span>
        <span class=kd>var</span> <span class=nx>fooCtrl</span> <span class=o>=</span> <span class=nx>controller</span><span class=p>;</span>
        <span class=nx>scope</span><span class=p>.</span><span class=nx>bar</span> <span class=o>=</span> <span class=nx>fooCtrl</span><span class=p>.</span><span class=nx>getFoo</span><span class=p>()</span> <span class=o>+</span> <span class=s1>&#39;bar&#39;</span><span class=p>;</span>
      <span class=p>}</span>
    <span class=p>};</span>
  <span class=p>});</span>
</code></pre></div><h3 id=bind-controller-to-elementdata>Bind controller to element.data</h3>
<p>Fundamentally Angular will bind directive&rsquo;s inline controller object to it&rsquo;s DOM through data property. When child directive is requiring parent directive, it will finally find the controller object in element.data. Based on this mechanism, we can mock parent directive controller by element.data.</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=c1>// speca.js
</span><span class=c1></span>
<span class=kd>var</span> <span class=nx>$scope</span><span class=p>,</span> <span class=nx>element</span><span class=p>;</span>
<span class=nx>beforeEach</span><span class=p>(</span><span class=nx>inject</span><span class=p>(</span><span class=kd>function</span><span class=p>(</span><span class=nx>$rootScope</span><span class=p>,</span> <span class=nx>$compile</span><span class=p>)</span> <span class=p>{</span>
  <span class=nx>$scope</span> <span class=o>=</span> <span class=nx>$rootScope</span><span class=p>.</span><span class=nx>$new</span><span class=p>();</span>
  <span class=nx>element</span> <span class=o>=</span> <span class=nx>angular</span><span class=p>.</span><span class=nx>element</span><span class=p>(</span><span class=s1>&#39;&lt;bar&gt;&lt;/bar&gt;&#39;</span><span class=p>);</span>
  <span class=c1>// bind the controller to element.data
</span><span class=c1></span>  <span class=nx>element</span><span class=p>.</span><span class=nx>data</span><span class=p>(</span><span class=s1>&#39;$fooController&#39;</span><span class=p>,</span> <span class=p>{</span>
    <span class=nx>getFoo</span><span class=o>:</span> <span class=kd>function</span> <span class=p>()</span> <span class=p>{</span> <span class=k>return</span> <span class=s1>&#39;foo&#39;</span><span class=p>;</span> <span class=p>}</span>
  <span class=p>});</span>
  <span class=nx>$compile</span><span class=p>(</span><span class=nx>element</span><span class=p>)(</span><span class=nx>$scope</span><span class=p>);</span>
<span class=p>}));</span>

<span class=nx>it</span><span class=p>(</span><span class=s1>&#39;should bind bar to scope&#39;</span><span class=p>,</span> <span class=kd>function</span><span class=p>()</span> <span class=p>{</span>
  <span class=nx>expect</span><span class=p>(</span><span class=nx>$scope</span><span class=p>.</span><span class=nx>bar</span><span class=p>).</span><span class=nx>toEqual</span><span class=p>(</span><span class=s1>&#39;foobar&#39;</span><span class=p>);</span>
<span class=p>});</span> 
</code></pre></div><h3 id=inject-the-directive>Inject the directive</h3>
<p>Another way is to inject the parent directive and mock it&rsquo;s controller property directly. This is also a straightforward way. But you might need to compile from parent directive even if you only want to test the child directive. See the example below:</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=kd>var</span> <span class=nx>$scope</span><span class=p>,</span> <span class=nx>element</span><span class=p>;</span>
<span class=nx>beforeEach</span><span class=p>(</span><span class=nx>inject</span><span class=p>(</span><span class=kd>function</span><span class=p>(</span><span class=nx>$rootScope</span><span class=p>,</span> <span class=nx>$compile</span><span class=p>,</span> <span class=nx>_fooDirective_</span><span class=p>)</span> <span class=p>{</span>
  <span class=kd>var</span> <span class=nx>fooDirective</span> <span class=o>=</span> <span class=nx>_fooDirective_</span><span class=p>[</span><span class=mi>0</span><span class=p>];</span>
  <span class=nx>fooDirective</span><span class=p>.</span><span class=nx>controller</span> <span class=o>=</span> <span class=kd>function</span> <span class=p>()</span> <span class=p>{</span>
    <span class=k>this</span><span class=p>.</span><span class=nx>getFoo</span> <span class=o>=</span> <span class=kd>function</span> <span class=p>()</span> <span class=p>{</span> <span class=k>return</span> <span class=s1>&#39;foo&#39;</span><span class=p>;</span> <span class=p>};</span>
  <span class=p>};</span>
    
  <span class=nx>$scope</span> <span class=o>=</span> <span class=nx>$rootScope</span><span class=p>.</span><span class=nx>$new</span><span class=p>();</span>
  <span class=c1>// compile from parent directive foo
</span><span class=c1></span>  <span class=nx>element</span> <span class=o>=</span> <span class=nx>angular</span><span class=p>.</span><span class=nx>element</span><span class=p>(</span><span class=s1>&#39;&lt;foo&gt;&lt;bar&gt;&lt;/bar&gt;&lt;/foo&gt;&#39;</span><span class=p>);</span>
  <span class=nx>$compile</span><span class=p>(</span><span class=nx>element</span><span class=p>)(</span><span class=nx>$scope</span><span class=p>);</span>
<span class=p>}));</span>

<span class=nx>it</span><span class=p>(</span><span class=s1>&#39;should bind bar to scope&#39;</span><span class=p>,</span> <span class=kd>function</span><span class=p>()</span> <span class=p>{</span>
  <span class=nx>expect</span><span class=p>(</span><span class=nx>$scope</span><span class=p>.</span><span class=nx>bar</span><span class=p>).</span><span class=nx>toEqual</span><span class=p>(</span><span class=s1>&#39;foobar&#39;</span><span class=p>);</span>
<span class=p>});</span>
</code></pre></div><p>I have a <a href="http://plnkr.co/edit/CUvQi8LQQ13fwHdgzgpw?p=preview">plunker</a> here to demo both ways of unit testing. And all that shedding light on me is this <a href=http://stackoverflow.com/questions/19227036/testing-directives-that-require-controllers>SO</a> post.</p>
</article>
</main><footer id=footer>
Copyright © 2022 hjl
</footer>
</body>
</html>